# 任务 13 上下文（实现过路费支付逻辑）

> 说明：本文件用于 Task 13 代码实现/复审前的上下文对齐，聚合 `tasks.json` + `tasks_back.json` / `tasks_gameplay.json` 的补充说明、相关契约与关键代码入口。
> 生成/更新日期：2025-12-22

## 0. 任务元信息（Taskmaster Triplet）

- Taskmaster ID: 13
- Title: 实现过路费支付逻辑
- Status: in-progress
- Dependencies: 12
- ADR: ADR-0005, ADR-0015, ADR-0018, ADR-0020, ADR-0021, ADR-0024, ADR-0025
- Overlay: docs/architecture/overlays/PRD-SANGUO-T2/08/08-功能纵切-T2-三国大富翁闭环.md
- tasks_back: SG-0013
- tasks_gameplay: GM-0013

tasks.json/details（原文）：
在玩家停留在他人城池时，计算应支付过路费并更新资金；若资金不足，则将剩余资金转给债权人，支付方资金归零并判定出局，同时释放其全部已占领城池为无人占领（回合轮转/游戏结束由 TurnManager 处理：玩家出局→GameOver；NPC 出局→退出本局）。
可选加固-审计追踪：记录城池购买/过路费支付/出局导致的城池释放（含涉及的玩家与城池列表）；写入结构化审计日志 `logs/ci/<YYYY-MM-DD>/security-audit.jsonl`（字段至少 {ts, action, reason, target, caller}）。
可选加固-事件溯源：对‘购买成功/支付过路费/出局/城池释放’发布 `DomainEvent`（ADR-0004），并保留 CorrelationId/CausationId 以支持回放与排障。
可选加固-资源限制：最大拥有城池数上限（可配置）；达到上限后购买失败且状态不变，同时记录审计/事件。

注：运行期安全基线要求仅使用 `res://`（只读）与 `user://`（读写）。因此“审计追踪”的运行期落盘应通过 Adapter 写入 `user://.../security-audit.jsonl`，CI/脚本再汇总到 `logs/ci/<YYYY-MM-DD>/security-audit.jsonl`。

## 1. 本任务落地口径（行为与不变式）

- 过路费计算：`City.GetToll(tollMultiplier, payerRules)`；倍数范围由 `SanguoEconomyRules.MaxTollMultiplier` 约束（1.0 表示原始过路费；0 允许用于特殊规则/测试）。
- 支付成功路径：payer 扣款；owner 收款（受 `Money` 上限封顶）；溢出部分进入 `SanguoTreasury`。
- 资金不足路径（破产/出局）：把 payer 剩余资金全部转给债权人（同样受封顶与溢出入国库规则约束）；payer 资金归零、标记出局、清空 `OwnedCityIds`（“出局后城池释放”的领域不变式）。
- 城池归属解析：以 `SanguoPlayer.OwnedCityIds` 为唯一事实来源；服务层通过 `SanguoBoardState.TryGetOwnerOfCity(cityId, out owner)` 解析 owner。

## 2. 事件契约（ADR-0004）

- 事件类型：`core.sanguo.city.toll.paid`
- 数据结构：`Game.Core/Contracts/Sanguo/EconomyEvents.cs` → `SanguoCityTollPaid`
  - `Amount`：从 payer 扣除的金额（major units）
  - `OwnerAmount`：实际入账给 owner 的金额（可能因封顶小于 Amount）
  - `TreasuryOverflow`：因 owner 封顶进入国库的溢出金额（major units）
  - 一致性约束：`Amount == OwnerAmount + TreasuryOverflow`

## 3. 关键代码入口（实现/调试）

- `Game.Core/Services/SanguoEconomyManager.cs`
  - `TryPayTollAndPublishEventAsync(...)`（本任务核心）
  - `TryBuyCityAndPublishEventAsync(...)`（与“唯一归属/事件发布”口径相同）
- `Game.Core/Domain/SanguoPlayer.cs`
  - `TryPayTollTo(...)`（破产/出局/清空城池 + 溢出入国库）
  - `TryBuyCity(...)`
- `Game.Core/Domain/SanguoBoardState.cs`
  - `TryGetOwnerOfCity(...)`（解析 owner）
  - `TryBuyCity(...)`（全局唯一归属购买规则）
- `Game.Core/Domain/ValueObjects/Money.cs`
  - `AddCapped(...)`、`MaxMajorUnits`
- `Game.Core/Domain/SanguoTreasury.cs`
  - `Deposit(...)`

## 4. 就地验收（测试钉死）

- 正常支付：余额变化正确；事件字段正确；`Amount == OwnerAmount + TreasuryOverflow`
- 城池无人占领：返回 `false`，不改变余额，不发布事件
- 资金不足：payer 出局 + 清空城池 + 资金归零；事件金额等于 payer 破产前剩余金额；`Amount == OwnerAmount + TreasuryOverflow`

## 5. Test-Refs

- `Game.Core.Tests/Services/SanguoEconomyManagerTests.cs`
- `Game.Core.Tests/Domain/SanguoPlayerTests.cs`
- `Game.Core.Tests/Domain/SanguoBoardStateTests.cs`
- `Game.Core.Tests/Domain/SanguoContractInstantiationTests.cs`

> 注：任务描述中的“可选加固（审计追踪/事件溯源/资源限制）”当前未在 Task 13 内实现，仅保留为后续任务的规划项。
