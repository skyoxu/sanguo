# 任务 22 上下文（实现UI骰子结果显示）

> 说明：本文件用于 Task 22 代码实现前的上下文准备，来自 Serena MCP 检索结果整理，供 TDD 和运行时测试直接引用。

## 0. 任务元信息（Taskmaster Triplet）

- Taskmaster ID: 22
- Title: 实现UI骰子结果显示
- Dependencies: 9, 5
- ADR: ADR-0005, ADR-0018, ADR-0022
- CH: CH01, CH04, CH06, CH07, CH10
- Overlay: `docs/architecture/overlays/PRD-SANGUO-T2/08/08-功能纵切-T2-三国大富翁闭环.md`
- ContractRefs: `core.sanguo.dice.rolled`

## 1. 关键符号与实现入口（Serena: find_symbol）

### 1.1 HUD (Godot UI)
- File: `Game.Godot/Scripts/UI/HUD.cs`
- Input event: Button `DiceButton` uses C# event `Pressed +=` (godot-csharp recommended)
- Current UI event published: `ui.hud.dice.roll` (via `EventBusAdapter.PublishSimple`) 
- Event subscription: connect `/root/EventBus` signal `DomainEventEmitted` to `OnDomainEventEmitted`

### 1.2 EventBusAdapter (Godot <-> Core bridge)
- File: `Game.Godot/Adapters/EventBusAdapter.cs`
- Signal: `DomainEventEmitted(type, source, dataJson, id, ...)`
- Helper: `PublishSimple(type, source, data_json)` for headless GdUnit4 tests

### 1.3 SanguoDiceService (Core publisher)
- File: `Game.Core/Services/SanguoDiceService.cs`
- Method: `RollD6(gameId, playerId, correlationId, causationId)`
- Publishes: `SanguoDiceRolled.EventType` with JSON fields `GameId/PlayerId/Value/OccurredAt/CorrelationId/CausationId` (PascalCase)

## 2. 现有接口与数据包装（Serena: search_for_pattern）

- IEventBus: `Game.Core/Services/EventBus.cs`
- DomainEvent: `Game.Core/Contracts/DomainEvent.cs`
- JsonElementEventData: `Game.Core/Contracts/JsonEventData.cs`

## 3. 事件契约（Serena: find_symbol）

### 3.1 SanguoDiceRolled
- File: `Game.Core/Contracts/Sanguo/BoardEvents.cs`
- EventType: `core.sanguo.dice.rolled`
- Fields: GameId (string), PlayerId (string), Value (int), OccurredAt (DateTimeOffset), CorrelationId (string), CausationId (nullable string)

## 4. 引用链（Serena: find_referencing_symbols）

- `SanguoDiceRolled.EventType` referenced by:
  - `Game.Core/Services/SanguoDiceService.cs` (publisher)
  - `Game.Core.Tests/Services/SanguoDiceServiceTests.cs` (assertions)

## 5. 止损要点（必读）

1) 二份 Game.Godot 文件镜像：headless GdUnit4 优先运行 `Tests.Godot/Game.Godot/**`。
   - 因此 Task 22 改 HUD 场景/脚本，必须同步修改两处：`Game.Godot/**` 和 `Tests.Godot/Game.Godot/**`。

2) 事件流空白：HUD 发出 `ui.hud.dice.roll`，但上下文中没有看到谁来消费该 UI 事件并调用 `SanguoDiceService.RollD6`。
   - 如果 Task 22 要完成闭环，需要明确 glue/manager 所属任务编号，避免越界抢了 Task 6/8/17 的职责。

