# Task 14 上下文（Serena MCP 注入）

> 目标：为 Task 14（实现月末收益结算）的代码实现准备“可复用、可回链、可验收”的上下文。
> 说明：`tasks.json` 不含 `test_refs`（格式限制），因此以 `tasks_back.json` 的 `acceptance/test_strategy/contractRefs/archRefs` 作为补充口径。

## 0) 任务映射（三文件）
- `tasks.json.master.tasks[].id=14`：实现月末收益结算（status=in-progress，deps=7,13）
- `tasks_back[].taskmaster_id=14`：`id=SG-0014`（status=pending，含 acceptance/test_strategy/contractRefs/archRefs）
- `tasks_gameplay[].taskmaster_id=14`：`id=GM-0014`（status=pending）

### tasks_back 关键字段（原文摘录）
- `archRefs`: CH01, CH04, CH05, CH06, CH07, CH09
- `contractRefs`: `core.sanguo.economy.month.settled`
- 关键约束：不得自行临时拼装 `players/citiesById`，必须消费 Task 12 引入的 `SanguoBoardState/SanguoGameState` 数据作为结算输入。

## 1) 现有功能扩展：关键符号（find_symbol）
### 1.1 结算入口与回合推进
- `Game.Core/Services/SanguoTurnManager.cs`
  - `SanguoTurnManager/AdvanceTurn(correlationId, causationId)`
  - 现状：在日期推进后调用 `_economy.PublishMonthSettlementIfBoundary(...)`，但 `settlements` 传入的是 `Array.Empty<PlayerSettlement>()`（占位）。

### 1.2 月末收益计算与事件发布
- `Game.Core/Services/SanguoEconomyManager.cs`
  - `SanguoEconomyManager/CalculateMonthSettlements(players, citiesById)`
    - 输入：`IReadOnlyList<ISanguoPlayerView>` + `IReadOnlyDictionary<string, City>`
    - 行为：跳过 `IsEliminated`，按 `OwnedCityIds` 累加月收益，产出 `PlayerSettlement(PlayerId, AmountDelta)`
  - `SanguoEconomyManager/PublishMonthSettlementIfBoundary(gameId, previousDate, currentDate, settlements, correlationId, causationId, occurredAt)`
    - 边界条件：同年月不发布
    - 发布事件：`Type = SanguoMonthSettled.EventType`，`Data = JsonElementEventData.FromObject(new SanguoMonthSettled(...))`
    - 发布方式：`_ = _bus.PublishAsync(evt)`（fire-and-forget）

### 1.3 数据持有/注入（避免旁路）
- `Game.Core/Domain/SanguoBoardState.cs`
  - 持有：`_playersById`, `_citiesById`
  - 入口：`TryGetOwnerOfCity(...)`, `TryBuyCity(...)`
  - 用途：作为 Task 14 的“数据来源聚合”候选（满足 tasks_back 的“不要临时拼装”约束）

## 2) 契约对齐：接口/数据结构（search_for_pattern）
### 2.1 事件总线接口
- `Game.Core/Services/EventBus.cs`
  - `public interface IEventBus { Task PublishAsync(DomainEvent evt); IDisposable Subscribe(Func<DomainEvent, Task> handler); }`

### 2.2 事件包络与数据
- `Game.Core/Contracts/DomainEvent.cs`
  - 字段：`Type`, `Source`, `Data`, `Timestamp`, `Id`, `SpecVersion`, `DataContentType`
- `Game.Core/Contracts/IEventData.cs`
  - `public interface IEventData { }`

## 3) 事件契约：月末结算（find_symbol）
- `Game.Core/Contracts/Sanguo/EconomyEvents.cs`
  - `PlayerSettlement`：仅作为 `SanguoMonthSettled` 的数据结构
  - `SanguoMonthSettled`
    - `EventType = "core.sanguo.economy.month.settled"`（与 tasks_back.contractRefs 对齐）
    - 字段：`GameId`, `Year`, `Month`, `PlayerSettlements`, `OccurredAt`, `CorrelationId`, `CausationId`

## 4) 架构理解：依赖引用（find_referencing_symbols）
### 4.1 月末事件的调用链（当前实现）
- `SanguoTurnManager/AdvanceTurn` → `SanguoEconomyManager/PublishMonthSettlementIfBoundary` → `IEventBus.PublishAsync`

### 4.2 既有回归用例（可作为 Task 14 的 Test-Refs 候选）
- `Game.Core.Tests/Services/SanguoTurnManagerTests.cs`
  - `AdvanceTurn_WhenMonthBoundaryReached_PublishesMonthSettledEvent`
  - `AdvanceTurn_WhenQuarterBoundaryReached_PublishesSeasonEventAppliedAfterMonthSettlement`（验证“月末事件先于季度事件”顺序）
- `Game.Core.Tests/Services/SanguoEconomyManagerTests.cs`
  - `PublishMonthSettlementIfBoundary_WhenMonthUnchanged_DoesNotPublish`
  - `PublishMonthSettlementIfBoundary_WhenMonthChanged_PublishesMonthSettled`
  - `CalculateMonthSettlements_*`（包含：跳过出局玩家、城市不存在抛异常等）

## 5) 止损建议（按你确认的口径）
1. 把月末收益结算做成纯 Core 的确定性计算：优先复用 `CalculateMonthSettlements(players, citiesById)`，避免在 `TurnManager` 里拼装/计算。
2. 移除占位数据：将 `AdvanceTurn` 中 `settlements: Array.Empty<PlayerSettlement>()` 替换为来自 `SanguoBoardState/SanguoGameState` 的实际快照计算结果。
3. 测试与回链：后续应把 Task 14 的 Test-Refs 以 `tasks_back.json` 为准挂到现有测试文件，避免只在 `tasks.json` 里丢失回链。

## 6) Serena MCP 查询记录（关键词）
- find_symbol: SanguoTurnManager, SanguoEconomyManager, SanguoBoardState, ISanguoPlayerView, IEventBus, DomainEvent, EconomyEvents, SanguoMonthSettled
- search_for_pattern: interface IEventBus / core.sanguo.* / Month boundary keywords
- find_referencing_symbols: SanguoEconomyManager/PublishMonthSettlementIfBoundary, SanguoTurnManager/AdvanceTurn, SanguoMonthSettled/EventType, IEventBus/PublishAsync