# Task 15：实现季度环境事件（Serena MCP 上下文）

生成日期：2026-01-02

## 任务三联（SSoT）

### tasks.json（Master）
- Id: `15`
- Title: `实现季度环境事件`
- Status: `pending`
- 关键语义：季度开始时按概率触发环境事件，影响某些区域（州郡）内城池收益（当季有效）。
- ADR Refs: `ADR-0005` `ADR-0015` `ADR-0018` `ADR-0020` `ADR-0021` `ADR-0024` `ADR-0025`
- Arch Refs: `CH01` `CH04` `CH05` `CH06` `CH07` `CH09`
- Overlay: `docs/architecture/overlays/PRD-SANGUO-T2/08/08-feature-slice-t2-monopoly-loop.md`

### tasks_back.json（SG 视图）
- View Id: `SG-0015`
- Layer/Status: `core` / `pending`
- Test Refs: `Game.Core.Tests/Tasks/Task15QuarterEventTests.cs`、`Game.Core.Tests/Services/QuarterlyEnvironmentEventTests.cs`
- contractRefs: `core.sanguo.economy.season.event.applied`

### tasks_gameplay.json（GM 视图）
- View Id: `GM-0015`
- Layer/Status: `core` / `pending`
- Test Refs: `Game.Core.Tests/Tasks/Task15QuarterEventTests.cs`、`Game.Core.Tests/Services/QuarterlyEnvironmentEventTests.cs`
- contractRefs: `core.sanguo.economy.season.event.applied`

## 契约（参考 ADR-0004 / ADR-0020）

- 领域事件：`core.sanguo.economy.season.event.applied`
- 合约类型：`Game.Core/Contracts/Sanguo/EconomyEvents.cs` → `SanguoSeasonEventApplied`
- 发布点：`Game.Core/Services/SanguoEconomyManager.cs` → `PublishSeasonEventIfBoundaryAsync`

## 运行时骨干（关键调用点）

- 回合推进：`Game.Core/Services/SanguoTurnManager.cs` → `AdvanceTurnAsync`
  - 跨季度边界：评估触发概率（可注入 RNG），触发后发布 `SanguoSeasonEventApplied`
- 月末结算：`Game.Core/Services/SanguoEconomyManager.cs` → `SettleMonth` / `CalculateMonthSettlements`
  - 当季收益调整在月结算中生效；进入下一季度后不延续（除非新季度再次触发）。

## 测试（Refs 对齐）

- `Game.Core.Tests/Tasks/Task15QuarterEventTests.cs`
  - 合约 EventType 常量、跨季度边界事件发布、当季不延续等验收锚点
- `Game.Core.Tests/Services/QuarterlyEnvironmentEventTests.cs`
  - RNG 可控/可复现、触发/未触发路径、仅影响受影响区域内城池收益等验收锚点

## 备注（边界/风险）

- 领域逻辑位于 `Game.Core`，不依赖 Godot API（便于 xUnit 快速回归）。
- 随机源通过注入 `IRandomNumberGenerator` 控制，可构造确定性“触发/未触发”路径。
