# Task 10 - 实现玩家棋子移动?Serena ????

## ???
- ????: 2025-12-18 00:32:07
- ????: `tasks.json.master.tasks[].id` ? `tasks_back[].taskmaster_id` ? `tasks_gameplay[].taskmaster_id`
- Task ID: `10`
- Status: `pending`
- Dependencies: 5, 9
- ADR Refs: ADR-0005, ADR-0015, ADR-0018, ADR-0020, ADR-0021, ADR-0024, ADR-0025
- CH Refs: CH01, CH04, CH05, CH06, CH07, CH09
- Overlay: `docs/architecture/overlays/PRD-SANGUO-T2/08/08-功能纵切-T2-三国大富翁闭环.md`

## tasks.json ????????
在 Godot 层实现“棋子移动”的展示与动画（Tween/插值），但不要在 Godot 层计算任何规则：步数、目标格子、路径点序列与“轮到谁/当前位置”等状态必须来自 Game.Core（依赖 Task 9 的棋盘/位置模型与 Task 5 的掷骰/状态更新）。

实现方式建议：
- 订阅 Core 事件并转换为 UI/动画指令（例如 core.sanguo.dice.rolled、core.sanguo.player.state.changed、core.sanguo.game.turn.started）。
- 动画按“路径点列表”逐段 Tween，结束后同步 HUD 显示。

止损约束：
- 禁止在 Godot 层硬编码事件名（必须使用 Game.Core.Contracts.Sanguo 中的 EventType 常量）。
- 禁止在 Godot 层实现“城市列表/路线/多步移动路径对照”规则，相关规则在 Task 3/Task 9 落地后再接入。

## tasks_back / tasks_gameplay ???????
- tasks_back: `SG-0010` / title=`实现玩家棋子移动`
- tasks_gameplay: `GM-0010` / title=`实现玩家棋子移动`

## 1) find_symbol??? symbols??????????
- `Game.Core.Services.SanguoTurnManager` ? `Game.Core/Services/SanguoTurnManager.cs`?Core ????? turn.* ?????Task 6 ????Task 10 ???????????
- `Game.Core.Services.SanguoDiceService` ? `Game.Core/Services/SanguoDiceService.cs`????? core.sanguo.dice.rolled?Task 5 ????Task 10 ???
- `Game.Godot.Adapters.EventBusAdapter` ? `Game.Godot/Adapters/EventBusAdapter.cs`?? DomainEvent ?? Godot Signal?DomainEventEmitted??UI/???????
- `Game.Godot.Scripts.UI.HUD` ? `Game.Godot/Scripts/UI/HUD.cs`????? _Ready ??? DomainEventEmitted ??? dataJson ?? UI
- `Game.Godot.Scripts.Navigation.ScreenNavigator` ? `Game.Godot/Scripts/Navigation/ScreenNavigator.cs`????CreateTween + await ToSignal(Finished) ?????
- `Game.Godot.Examples.Components.Toast` ? `Game.Godot/Examples/Components/Toast.cs`????CreateTween ????/??????????/???/?????????
- `Game.Godot.Scripts.UI.MainMenu` ? `Game.Godot/Scripts/UI/MainMenu.cs`????PublishSimple ?? UI ??????????????Task 10 ??????????

## 2) search_for_pattern???/???????
- `IEventBus` ? `Game.Core/Services/EventBus.cs`?Core ???????PublishAsync/Subscribe?
- `DomainEvent` ? `Game.Core/Contracts/DomainEvent.cs`?CloudEvents-like envelope?Type/Source/Data/Timestamp/Id/SpecVersion/DataContentType?
- `IEventData` ? `Game.Core/Contracts/IEventData.cs`??? payload marker??? object/dynamic?
- `JsonElementEventData / RawJsonEventData` ? `Game.Core/Contracts/JsonEventData.cs`?payload ?????JsonElement/RawJson?

## 3) find_symbol??????ADR-0004 ???
Task 10 ?????????/??????????? Tween ?????????? `EventType` ????????????

### `SanguoTokenMoved` (`core.sanguo.board.token.moved`)
- ????: `Game.Core/Contracts/Sanguo/BoardEvents.cs`
- ??: GameId, PlayerId, FromIndex, ToIndex, Steps, PassedStart, OccurredAt, CorrelationId, CausationId
- ??: Task 10 ????????????????????????????????/??????

### `SanguoDiceRolled` (`core.sanguo.dice.rolled`)
- ????: `Game.Core/Contracts/Sanguo/BoardEvents.cs`
- ??: GameId, PlayerId, Value, OccurredAt, CorrelationId, CausationId
- ??: Task 5 ????Task 10 ????????????/?????

### `SanguoPlayerStateChanged` (`core.sanguo.player.state.changed`)
- ????: `Game.Core/Contracts/Sanguo/PlayerAndAiEvents.cs`
- ??: GameId, PlayerId, Money, PositionIndex, OccurredAt, CorrelationId, CausationId
- ??: ?? HUD/???????/????????????????

### `SanguoGameTurnStarted` (`core.sanguo.game.turn.started`)
- ????: `Game.Core/Contracts/Sanguo/GameEvents.cs`
- ??: GameId, TurnNumber, ActivePlayerId, Year, Month, Day, OccurredAt, CorrelationId, CausationId
- ??: Task 6 ????Task 10 ?????????????????????

## 4) find_referencing_symbols???????????????
### `SanguoDiceRolled`????????
- `Game.Core/Services/SanguoDiceService.cs::RollD6`?DomainEvent(Type=SanguoDiceRolled.EventType)

### `SanguoTokenMoved`??????
- `Game.Core.Tests/Domain/SanguoContractsTests.cs`???? EventType ??
- `Game.Core.Tests/Domain/SanguoContractInstantiationTests.cs`????????
???Task 10 ?????????????????????? `core.sanguo.board.token.moved`???? Core ????????????? Task 9 ???/????????????

### `EventBusAdapter`?Godot ??????
- `Game.Godot/Autoloads/CompositionRoot.cs::InitializePorts`?RequireAutoload("/root/EventBus")
- `Game.Godot/Scripts/UI/HUD.cs::_Ready`?Connect DomainEventEmitted ??? JSON
- `Game.Godot/Scripts/UI/MainMenu.cs::Publish`?PublishSimple ?? UI ??????
- `Game.Godot/Scripts/Demo/GameEngineDemo.cs::_Ready`?GetNodeOrNull("/root/EventBus") ? fail-fast

### Tween/?????Godot C# ?????
- `Game.Godot/Scripts/Navigation/ScreenNavigator.cs::FadeAndSwitch`?CreateTween + await ToSignal(Tween.SignalName.Finished)
- `Game.Godot/Examples/Components/Toast.cs::ShowToast`?CreateTween + TweenProperty(modulate:a)

## ??????? Task 10?
- ????Godot???????? ? ?? JSON payload ? ????/??? ? ????????Tween?
- ????Game.Core???????????????/???????/????Godot ???????
- ??????? `HUD.cs` ? `bus.Connect(EventBusAdapter.SignalName.DomainEventEmitted, new Callable(this, nameof(OnDomainEventEmitted)))`?
- JSON ??????? `HUD.cs` ?? `JsonDocument.Parse(dataJson)`???????/??? fail-safe???????????????????????

## ????????????
- Task 9 ???? Core ??? `SanguoTokenMoved`??????? payload ???????????????? From/To/Steps ?????????????
- Task 3/Task 9 ??????/??/????????????????????Node2D ???TileMap cell???? Marker2D??
