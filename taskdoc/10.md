# 任务 10 上下文（实现玩家棋子移动）

> 说明：本文件用于 Task 10 代码实现前的上下文准备，用来对齐任务目标、契约事件、及 Godot/C# 实现入口。

## 0. 任务元信息（Taskmaster Triplet）

- Taskmaster ID: 10
- Title: 实现玩家棋子移动
- Status: in-progress
- Dependencies: 5, 9
- ADR: ADR-0005, ADR-0015, ADR-0018, ADR-0020, ADR-0021, ADR-0024, ADR-0025
- CH: CH01, CH04, CH05, CH06, CH07, CH09
- Overlay: docs/architecture/overlays/PRD-SANGUO-T2/08/08-功能纵切-T2-三国大富翁闭环.md

## 1. 目标与责任边界（止损）

- Godot 层：只负责展示与动画（Tween/插值），不计算任何规则（步数、目标格、路径点、轮到谁、当前位置等都必须来自 Game.Core）。
- Core 层：负责状态更新（位置/路径点等），并可以通过事件将状态更新通知到 Godot 层。
- 两份镜像资源：涉及场景/脚本的修改，需同步修改 Game.Godot/** 和 Tests.Godot/Game.Godot/**，避免 headless 测试跟不上。

## 2. 关键契约与字段（优先复用既有契约）

- 领域事件（Contracts）
  - SanguoTokenMoved.EventType = core.sanguo.board.token.moved
    - 契约位置：Game.Core/Contracts/Sanguo/BoardEvents.cs
    - 字段：GameId/PlayerId/FromIndex/ToIndex/Steps/PassedStart/OccurredAt/CorrelationId/CausationId
  - SanguoPlayerStateChanged.EventType
    - 字段包含 PositionIndex（可用于 UI 展示）

## 3. 已有实装现状概览（需要综合取证）

- Game.Godot/Scenes/Main.tscn 当前主场景包含 HUD，但还没有专门的棋盘/棋子可视化场景（需要在 Task 10 新建或补齐结构）。
- SanguoTokenMoved 契约已存在，但目前引用主要出现在契约自测，还没看到具体发布者、消费者在播放动画路径上的入口（需在实现时明确链路）。

## 4. 建议参考（仅借鉴结构与模式，不直接复制代码）

- Godot 官方 demo：C:\buildgame\godotdemo\demo\godot-demo-projects
  - 2d/hexagonal_map
  - 2d/dynamic_tilemap_layers

## 5. 就地验收与测试占位（用于 TDD 红/绿/重构）

- xUnit（Core）
  - 位置计算、环形路径包装、事件发布的纯逻辑测试（不依赖 Godot）。
- GdUnit4（Godot）
  - 棋子节点可视性、得到移动事件后更新位置（两份镜像资源同步验证）。
