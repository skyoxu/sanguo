# Task 5: 实现骰子机制

## 0. 映射与来源
- Mapping: `tasks.json.master.tasks[].id` (`"5"`) <-> `tasks_back[].taskmaster_id` <-> `tasks_gameplay[].taskmaster_id`
- 注意：`tasks.json` 的 `id` 是字符串；back/gameplay 里 `taskmaster_id` 可能是数字，做关联时统一 `str()`。

## 1. 任务元信息（从三份任务文件汇总）
- tasks.json: title=`实现骰子机制`, status=`in-progress`, priority=`medium`, dependencies=`['1']`
- tasks.json.details:
  - 使用随机数生成器实现骰子投掷，返回1到6的随机数。
- tasks.json.testStrategy:
  - 单元测试（xUnit + FluentAssertions）：
  - 掷骰结果始终在 1..6（含边界）。
  - 随机源可控（优先复用 `Game.Core/Utilities/RandomHelper.cs`；必要时允许注入随机源以便确定性测试）。
  - 事件对齐（ADR-0004）：掷骰后发布 `SanguoDiceRolled`（`Game.Core/Contracts/Sanguo/BoardEvents.cs`），并验证 `DomainEvent.Type == SanguoDiceRolled.EventType` 且 Value 与点数一致。
  - 覆盖率门禁：lines>=90%、branches>=85%（ADR-0005）；产物归档到 `logs/unit/<YYYY-MM-DD>/`。
- tasks_back.json: id=`SG-0005`, layer=`core`, status=`pending`, priority=`P1`, depends_on=`['SG-0001']`
  - adr_refs=`['ADR-0005', 'ADR-0015', 'ADR-0018', 'ADR-0020', 'ADR-0021', 'ADR-0024', 'ADR-0025']`
  - chapter_refs=`['CH01', 'CH04', 'CH05', 'CH06', 'CH07', 'CH09']`
  - overlay_refs=`['docs/architecture/overlays/PRD-SANGUO-T2/08/08-功能纵切-T2-三国大富翁闭环.md']`
  - acceptance:
    - 核心玩法相关类与方法在 Game.Core 中实现且不依赖 Godot API。
    - 对应任务的 xUnit 测试用例存在并通过（见 test_refs 占位路径）。
  - test_strategy:
    - xUnit + FluentAssertions：掷骰结果始终在 1..6（含边界）。
    - 随机性可测试：优先复用 `Game.Core/Utilities/RandomHelper.cs`；必要时允许注入随机源以便确定性测试。
    - 事件对齐（ADR-0004）：掷骰后发布 `SanguoDiceRolled`（`Game.Core/Contracts/Sanguo/BoardEvents.cs`）；用可捕获的 `IEventBus` 断言 `DomainEvent.Type == SanguoDiceRolled.EventType` 且 Value 与点数一致。
    - 覆盖率门禁：运行 `dotnet test --collect:"XPlat Code Coverage"` 并通过 `py -3 scripts/python/run_dotnet.py` 校验（lines>=90%、branches>=85%）；产物归档到 `logs/unit/<YYYY-MM-DD>/`。
    - 可选统计（软门）：投掷 10_000 次输出频次分布到 `logs/perf/<YYYY-MM-DD>/summary.json`，仅用于回归观察。
- tasks_gameplay.json: id=`GM-0005`, layer=`core`, status=`pending`, priority=`P1`, depends_on=`['GM-0001']`
  - adr_refs=`['ADR-0005', 'ADR-0015', 'ADR-0018', 'ADR-0020', 'ADR-0021', 'ADR-0024', 'ADR-0025']`
  - chapter_refs=`['CH01', 'CH04', 'CH05', 'CH06', 'CH07', 'CH09']`
  - overlay_refs=`['docs/architecture/overlays/PRD-SANGUO-T2/08/08-功能纵切-T2-三国大富翁闭环.md']`
  - acceptance:
    - 核心玩法相关类与方法在 Game.Core 中实现且不依赖 Godot API。
    - 对应任务的 xUnit 测试用例存在并通过（见 test_refs 占位路径）。
  - test_strategy:
    - xUnit + FluentAssertions：掷骰结果始终在 1..6（含边界）。
    - 随机性可测试：优先复用 `Game.Core/Utilities/RandomHelper.cs`；必要时允许注入随机源以便确定性测试。
    - 事件对齐（ADR-0004）：掷骰后发布 `SanguoDiceRolled`（`Game.Core/Contracts/Sanguo/BoardEvents.cs`）；用可捕获的 `IEventBus` 断言 `DomainEvent.Type == SanguoDiceRolled.EventType` 且 Value 与点数一致。
    - 覆盖率门禁：运行 `dotnet test --collect:"XPlat Code Coverage"` 并通过 `py -3 scripts/python/run_dotnet.py` 校验（lines>=90%、branches>=85%）；产物归档到 `logs/unit/<YYYY-MM-DD>/`。
    - 可选统计（软门）：投掷 10_000 次输出频次分布到 `logs/perf/<YYYY-MM-DD>/summary.json`，仅用于回归观察。

## 2. Serena 检索结果（为实现准备上下文）
- 说明：当前 Codex 会话未接入 Serena MCP 工具，本节用本地 `rg` 结果近似 Serena 的 4 类查询输出。
### 2.1 find_symbol：随机/掷骰/事件总线相关符号
- `RandomHelper`：Game.Core\Utilities\RandomHelper.cs:3:public static class RandomHelper
- `Dice (expected)`：未找到（需要新建或改用现有命名）。
- `SanguoDiceRolled`：Game.Core\Contracts\Sanguo\BoardEvents.cs:37:public sealed record SanguoDiceRolled(
- `IEventBus`：Game.Core\Services\EventBus.cs:6:public interface IEventBus
- `InMemoryEventBus`：Game.Core\Services\EventBus.cs:12:public class InMemoryEventBus : IEventBus
- `DomainEvent`：Game.Core\Contracts\DomainEvent.cs:9:public record DomainEvent(
- `IEventData`：Game.Core\Contracts\IEventData.cs:9:public interface IEventData
- `JsonElementEventData`：Game.Core\Contracts\JsonEventData.cs:20:public sealed record JsonElementEventData(JsonElement Value) : IEventData

### 2.2 search_for_pattern：现有端口/接口契约（避免重复造轮子）
- `IEventBus`：Game.Core\Services\EventBus.cs:6:public interface IEventBus
- `IEventData`：Game.Core\Contracts\IEventData.cs:9:public interface IEventData
- `ITime`：Game.Core\Ports\ITime.cs:3:public interface ITime
- `ILogger`：Game.Core\Ports\ILogger.cs:3:public interface ILogger
- `IErrorReporter`：Game.Core\Ports\IErrorReporter.cs:12:public interface IErrorReporter

### 2.3 find_symbol：事件契约（ADR-0004 口径）
- docs\architecture\overlays\PRD-SANGUO-T2\08\08-功能纵切-T2-三国大富翁闭环.md:110:- 事件名：`core.sanguo.dice.rolled`  
- Game.Core\Contracts\Sanguo\BoardEvents.cs:30:/// Domain event: core.sanguo.dice.rolled
- Game.Core\Contracts\Sanguo\BoardEvents.cs:49:    public const string EventType = "core.sanguo.dice.rolled";

### 2.4 find_referencing_symbols：依赖引用/调用方式
- `RandomHelper` 引用点（测试/迁移文档为主）：
  - Game.Core\Utilities\RandomHelper.cs:3:public static class RandomHelper
  - Game.Core.Tests\Utilities\RandomHelperTests.cs:10:public class RandomHelperTests
  - Game.Core.Tests\Utilities\RandomHelperTests.cs:17:            .Select(_ => RandomHelper.NextInt(0, 10))
  - Game.Core.Tests\Utilities\RandomHelperTests.cs:33:            .Select(_ => RandomHelper.NextInt(0, 100))
  - Game.Core.Tests\Utilities\RandomHelperTests.cs:46:            .Select(_ => RandomHelper.NextDouble())
  - Game.Core.Tests\Utilities\RandomHelperTests.cs:62:            .Select(_ => RandomHelper.NextDouble())
  - Game.Core.Tests\Utilities\RandomHelperTests.cs:71:    public async Task RandomHelperShouldBeThreadSafe()
  - Game.Core.Tests\Utilities\RandomHelperTests.cs:80:                    results.Add(RandomHelper.NextInt(0, 100));
  - docs\migration\Phase-3-Project-Structure.md:127:    ├── RandomHelper.cs
  - docs\migration\Phase-4-Domain-Layer.md:29:├─ 数学工具类 (MathHelper, RandomHelper)
  - docs\migration\Phase-4-Domain-Layer.md:500:- [ ] RandomHelper (NextInt, NextDouble, Choose)
- `SanguoDiceRolled` 引用点（契约测试与 Overlay 文档为主）：
  - Game.Core\Contracts\Sanguo\BoardEvents.cs:37:public sealed record SanguoDiceRolled(
  - Game.Core.Tests\Domain\SanguoContractInstantiationTests.cs:38:        var rolled = new SanguoDiceRolled(
  - docs\architecture\overlays\PRD-SANGUO-T2\08\08-功能纵切-T2-三国大富翁闭环.md:113:  - 契约文件：`Game.Core/Contracts/Sanguo/BoardEvents.cs` 中 `SanguoDiceRolled`。

## 3. 实现建议（止损视角）
- Task 5 语义只要求 D6 随机点数；建议优先复用 `Game.Core/Utilities/RandomHelper.cs`（ThreadLocal<Random>），避免引入第二套 RNG。
- 如果需要‘可复现测试’，不要在 Core 里直接 new Random()：用可注入随机源（接口/委托）包一层；测试可传入固定序列。
- 事件命名优先对齐 `core.sanguo.dice.rolled`（见 `Game.Core/Contracts/Sanguo/BoardEvents.cs`），不要继续扩展 `game.*` 或 `player.*` 老事件名，避免与 ADR-0004 口径分裂。
- 现有 `DomainEvent.Data` 只接受 `IEventData`，而 `SanguoDiceRolled` 是契约 record（不实现接口）；如果要通过事件总线发布，短期用 `JsonElementEventData.FromObject(...)` 承载 payload，避免引入 `object`/动态类型。
