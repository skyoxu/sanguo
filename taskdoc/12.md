# 任务 12 上下文（实现土地购买逻辑）

> 说明：本文件用于 Task 12 代码实现前的上下文准备（Serena MCP 输出摘要），用来对齐任务目标、既有契约（ADR-0004）与现有模块调用关系。
> 生成日期：2025-12-22

## 0. 任务元信息（Taskmaster Triplet）

- Taskmaster ID: 12
- Title: 实现土地购买逻辑
- Status: in-progress
- Dependencies: 4, 10
- ADR: ADR-0005, ADR-0015, ADR-0018, ADR-0020, ADR-0021, ADR-0024, ADR-0025
- CH: CH01, CH04, CH05, CH06, CH07, CH09
- Overlay: docs/architecture/overlays/PRD-SANGUO-T2/08/08-功能纵切-T2-三国大富翁闭环.md
- tasks_back 映射条目数: 1（当前仅占位/无补充细节）
- tasks_gameplay 映射条目数: 1（当前仅占位/无补充细节）

tasks.json/details（原文）：
在玩家停留在无人城池时，提供购买选项，扣除资金并更新城池所有权。
可选加固-审计追踪：记录城池购买/过路费支付/出局导致的城池释放（含涉及的玩家与城池列表）；写入结构化审计日志 `logs/ci/<YYYY-MM-DD>/security-audit.jsonl`（字段至少 {ts, action, reason, target, caller}）。
可选加固-事件溯源：对‘购买成功/支付过路费/出局/城池释放’发布 `DomainEvent`（ADR-0004），并保留 CorrelationId/CausationId 以支持回放与排障。
可选加固-资源限制：最大拥有城池数上限（可配置）；达到上限后购买失败且状态不变，同时记录审计/事件。

tasks.json/testStrategy（原文）：
通过多次购买测试，验证购买逻辑的正确性和资金更新。
Local demo paths: C:\buildgame\godotdemo\dafuweng\monopoly_clone ; C:\buildgame\godotdemo\dafuweng\Prototype
加入 xUnit 用例：买地/付费/出局释放城池时，断言审计条目写入且字段完整。
加入 xUnit 用例：买地/付费/出局/城池释放均发布 DomainEvent；校验事件 type/source/id/correlationId 以及顺序可回放。
加入 xUnit 用例：当 OwnedCityIds.Count 达到上限时，TryBuyCity 返回 false 且资金/OwnedCityIds 不变，并写入审计条目。

## 1. 建议检索关键词（用于 Serena）

- 购买入口：`SanguoPlayer` / `TryBuyCity` / `OwnedCityIds`
- 城池与定价：`City` / `GetPrice` / `MoneyValue` / `SanguoEconomyRules`
- 依赖注入与投影：`ISanguoPlayerView` / `citiesById`
- 事件与契约：`IEventBus` / `DomainEvent` / `JsonElementEventData` / `SanguoCityBought` / `SanguoCityTollPaid`
- 审计：`AUDIT_LOG_ROOT` / `security-audit.jsonl`

## 2. [1] find_symbol：核心符号（实现入口）

### 2.1 `SanguoPlayer.TryBuyCity`（购买入口：扣钱 + 记录 OwnedCityIds）

路径：`Game.Core/Domain/SanguoPlayer.cs`

```csharp
public bool TryBuyCity(City city, decimal priceMultiplier)
{
    AssertThread();

    if (IsEliminated)
        return false;

    ArgumentNullException.ThrowIfNull(city, nameof(city));

    if (priceMultiplier < 0)
        throw new ArgumentOutOfRangeException(nameof(priceMultiplier), "Price multiplier must be non-negative.");

    if (_ownedCityIds.Contains(city.Id))
        return false;

    var price = city.GetPrice(priceMultiplier, _economyRules);
    if (Money < price)
        return false;

    Money -= price;
    _ownedCityIds.Add(city.Id);
    return true;
}
```

止损提示：
- 该方法目前“只更新玩家视角（OwnedCityIds）”，并未修改任何“全局城池所有权状态”；Task 12 的“更新城池所有权”需要明确由谁持有/维护城池拥有者映射。

### 2.2 `City.GetPrice`（价格计算：倍率上限由规则控制）

路径：`Game.Core/Domain/City.cs`

```csharp
public MoneyValue GetPrice(decimal multiplier, SanguoEconomyRules rules)
{
    if (multiplier < 0 || multiplier > rules.MaxPriceMultiplier)
        throw new ArgumentOutOfRangeException(nameof(multiplier), $"Multiplier must be between 0 and {rules.MaxPriceMultiplier}.");

    return MoneyValue.FromDecimal(BasePrice.ToDecimal() * multiplier);
}
```

### 2.3 `SanguoEconomyRules`（倍率上限：默认 1000）

路径：`Game.Core/Domain/SanguoEconomyRules.cs`

```csharp
public readonly struct SanguoEconomyRules
{
    public const decimal DefaultMaxPriceMultiplier = 1000m;
    public const decimal DefaultMaxTollMultiplier = 1000m;

    public static SanguoEconomyRules Default => new(
        maxPriceMultiplier: DefaultMaxPriceMultiplier,
        maxTollMultiplier: DefaultMaxTollMultiplier);

    public SanguoEconomyRules(decimal maxPriceMultiplier, decimal maxTollMultiplier)
    {
        if (maxPriceMultiplier < 0)
            throw new ArgumentOutOfRangeException(nameof(maxPriceMultiplier), "MaxPriceMultiplier must be non-negative.");

        if (maxTollMultiplier < 0)
            throw new ArgumentOutOfRangeException(nameof(maxTollMultiplier), "MaxTollMultiplier must be non-negative.");

        MaxPriceMultiplier = maxPriceMultiplier;
        MaxTollMultiplier = maxTollMultiplier;
    }

    public decimal MaxPriceMultiplier { get; }

    public decimal MaxTollMultiplier { get; }
}
```

### 2.4 `ISanguoPlayerView`（服务层消费的只读投影）

路径：`Game.Core/Domain/ISanguoPlayerView.cs`

```csharp
public interface ISanguoPlayerView
{
    string PlayerId { get; }
    Money Money { get; }
    int PositionIndex { get; }
    IReadOnlyCollection<string> OwnedCityIds { get; }
    bool IsEliminated { get; }
}
```

### 2.5 `SanguoEconomyManager.CalculateMonthSettlements`（说明已有 `players + citiesById` 的数据注入模式）

路径：`Game.Core/Services/SanguoEconomyManager.cs`

```csharp
public IReadOnlyList<PlayerSettlement> CalculateMonthSettlements(
    IReadOnlyList<ISanguoPlayerView> players,
    IReadOnlyDictionary<string, City> citiesById
)
{
    // ...
}
```

## 3. [2] search_for_pattern：接口定义（了解既有契约）

- `IEventBus`：`Game.Core/Services/EventBus.cs`（`PublishAsync` / `Subscribe`）
- `DomainEvent`：`Game.Core/Contracts/DomainEvent.cs`
- `JsonElementEventData`：`Game.Core/Contracts/JsonEventData.cs`（`FromObject<T>`）
- `ITime`：`Game.Core/Ports/ITime.cs`
- `AUDIT_LOG_ROOT`：`scripts/sc/test.py`（用于将审计/安全相关产物写入 `logs/ci/<date>`）
- `security-audit.jsonl`（文档口径参考）：
  - `docs/architecture/base/02-security-baseline-godot-v2.md`
  - `docs/architecture/base/01-introduction-and-goals-v2.md`
  - `docs/adr/ADR-0006-data-storage.md`
  - `docs/migration/Phase-13-Quality-Gates-Backlog.md`

## 4. [3] find_symbol：事件契约（ADR-0004）

### 4.1 城池相关事件（Task 12 直接可复用，禁止自造事件名）

路径：`Game.Core/Contracts/Sanguo/EconomyEvents.cs`

```csharp
public sealed record SanguoCityBought(
    string GameId,
    string BuyerId,
    string CityId,
    decimal Price,
    DateTimeOffset OccurredAt,
    string CorrelationId,
    string? CausationId
)
{
    public const string EventType = "core.sanguo.city.bought";
}

public sealed record SanguoCityTollPaid(
    string GameId,
    string PayerId,
    string OwnerId,
    string CityId,
    decimal Amount,
    DateTimeOffset OccurredAt,
    string CorrelationId,
    string? CausationId
)
{
    public const string EventType = "core.sanguo.city.toll.paid";
}
```

### 4.2 事件发布模式（参考现有实现）

示例：`SanguoEconomyManager.PublishMonthSettlementIfBoundary`（已有实现）

```csharp
var evt = new DomainEvent(
    Type: SanguoMonthSettled.EventType,
    Source: nameof(SanguoEconomyManager),
    Data: JsonElementEventData.FromObject(new SanguoMonthSettled(
        GameId: gameId,
        Year: previousDate.Year,
        Month: previousDate.Month,
        PlayerSettlements: settlements,
        OccurredAt: occurredAt,
        CorrelationId: correlationId,
        CausationId: causationId
    )),
    Timestamp: DateTime.UtcNow,
    Id: Guid.NewGuid().ToString("N")
);

_ = _bus.PublishAsync(evt);
```

## 5. [4] find_referencing_symbols：依赖引用（了解如何被使用）

- `SanguoPlayer.TryBuyCity`：目前只在 `Game.Core.Tests/Domain/SanguoPlayerTests.cs` 被调用（说明 Task 12 仍缺“回合/流程/城市所有权映射”的业务接线）。
- `SanguoCityBought`：目前只在 `Game.Core.Tests/Domain/SanguoContractInstantiationTests.cs` 被实例化（契约存在，但缺发布者）。
- `SanguoEconomyManager`：由 `SanguoTurnManager` 构造注入，并以 `DomainEvent + JsonElementEventData` 方式发布边界事件；Task 12 的事件发布可参考此模式。

## 6. 关键缺口与风险（止损）

1) “更新城池所有权”的全局状态还没有明确持有者：`TryBuyCity` 只更新玩家 OwnedCityIds，不足以支撑“无人城池/已被占领/出局释放”等判定。
2) Task 12 要求审计与事件溯源，但目前 `SanguoCityBought/SanguoCityTollPaid` 契约尚未在业务流程中被发布；实现时应优先复用既有契约，而不是新建 Contracts 文件。
3) tasks_back / tasks_gameplay 对 Task 12 暂无补充说明（仅占位），以 `tasks.json` 为唯一依据。
