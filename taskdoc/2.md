# Task 2: 创建环形地图数据结构

## 0. 映射与来源
- Mapping: `tasks.json.master.tasks[].id` (`"2"`) <-> `tasks_back[].taskmaster_id` <-> `tasks_gameplay[].taskmaster_id`
- 注意：`tasks.json` 的 `id` 是字符串；views 文件里是数字，做关联时需 `str()` 归一化，否则会出现“找不到关联”的假报错。

## 1. 任务元信息（从三份任务文件汇总）
- tasks.json: title=`创建环形地图数据结构`, status=`in-progress`, priority=`high`
- tasks.json.details:
  - 使用 C# 中的 List<City> 来存储城池信息，实现根据当前位置和骰子点数计算新位置的环形地图逻辑。在地图与关卡设计上，可参考 Godot 官方演示项目 2d/hexagonal_map、2d/dynamic_tilemap_layers 等示例的场景组织方式，只借鉴数据与场景结构，不直接复制代码。
- tasks_back.json: layer=`core`, depends_on=`['SG-0001']`
  - adr_refs=`['ADR-0005', 'ADR-0015', 'ADR-0018', 'ADR-0020', 'ADR-0021', 'ADR-0024', 'ADR-0025']`
  - chapter_refs=`['CH01', 'CH04', 'CH05', 'CH06', 'CH07', 'CH09']`
  - overlay_refs=`['docs/architecture/overlays/PRD-SANGUO-T2/08/08-功能纵切-T2-三国大富翁闭环.md']`
  - acceptance:
    - 核心玩法相关类与方法在 Game.Core 中实现且不依赖 Godot API。
    - 对应任务的 xUnit 测试用例存在并通过（见 test_refs 占位路径）。
    - 符合学习模块一（棋盘 / 城池 / 环形路线）的任务分解：在棋盘与场景结构上参考 Godot 官方演示项目 2d/hexagonal_map、2d/dynamic_tilemap_layers，只借鉴结构与模式，不直接复制代码。
    - Local demo references: C:\buildgame\godotdemo\demo\godot-demo-projects\2d\hexagonal_map ; C:\buildgame\godotdemo\demo\godot-demo-projects\2d\dynamic_tilemap_layers ; C:\buildgame\godotdemo\dafuweng\monopoly_clone
  - test_strategy:
    - 为核心玩法编写 xUnit + FluentAssertions 单元测试覆盖主要状态机与计算。
    - 使用覆盖率工具（coverlet）确保核心逻辑达到 ADR-0005 规定的门禁。
    - 在本项目实现前，先运行并阅读 2d/hexagonal_map 或相关 TileMap 演示项目，据此设计一组棋盘位置与移动路径的单元测试 / 场景测试，用于验证环形路线与城池状态更新逻辑。
    - Local demo paths for implementation/tests: C:\buildgame\godotdemo\demo\godot-demo-projects\2d\hexagonal_map ; C:\buildgame\godotdemo\demo\godot-demo-projects\2d\dynamic_tilemap_layers ; C:\buildgame\godotdemo\dafuweng\monopoly_clone
- tasks_gameplay.json: layer=`core`, depends_on=`['GM-0001']`
  - adr_refs=`['ADR-0005', 'ADR-0015', 'ADR-0018', 'ADR-0020', 'ADR-0021', 'ADR-0024', 'ADR-0025']`
  - chapter_refs=`['CH01', 'CH04', 'CH05', 'CH06', 'CH07', 'CH09']`
  - overlay_refs=`['docs/architecture/overlays/PRD-SANGUO-T2/08/08-功能纵切-T2-三国大富翁闭环.md']`
  - acceptance:
    - 核心玩法相关类与方法在 Game.Core 中实现且不依赖 Godot API。
    - 对应任务的 xUnit 测试用例存在并通过（见 test_refs 占位路径）。
    - 符合学习模块一（棋盘 / 城池 / 环形路线）的任务分解：在棋盘与场景结构上参考 Godot 官方演示项目 2d/hexagonal_map、2d/dynamic_tilemap_layers，只借鉴结构与模式，不直接复制代码。
    - Local demo references: C:\buildgame\godotdemo\demo\godot-demo-projects\2d\hexagonal_map ; C:\buildgame\godotdemo\demo\godot-demo-projects\2d\dynamic_tilemap_layers ; C:\buildgame\godotdemo\dafuweng\monopoly_clone
  - test_strategy:
    - 为核心玩法编写 xUnit + FluentAssertions 单元测试覆盖主要状态机与计算。
    - 使用覆盖率工具（coverlet）确保核心逻辑达到 ADR-0005 规定的门禁。
    - 在本项目实现前，先运行并阅读 2d/hexagonal_map 或相关 TileMap 演示项目，据此设计一组棋盘位置与移动路径的单元测试 / 场景测试，用于验证环形路线与城池状态更新逻辑。
    - Local demo paths for implementation/tests: C:\buildgame\godotdemo\demo\godot-demo-projects\2d\hexagonal_map ; C:\buildgame\godotdemo\demo\godot-demo-projects\2d\dynamic_tilemap_layers ; C:\buildgame\godotdemo\dafuweng\monopoly_clone

## 2. Serena 检索结果（为实现准备上下文）
### 2.1 find_symbol：核心移动入口与位置模型
- `Game.Core/Engine/GameEngineCore.cs`：`GameEngineCore`，当前移动入口为 `Move(double dx, double dy)`（还不是棋盘 index 语义）。
- `Game.Core/Domain/ValueObjects/Position.cs`：`Position` struct（`X`, `Y`, `Add(dx,dy)`），被 `GameState` 与 `Player` 直接持有。
- `City`：Serena 全仓库 `find_symbol City` 结果为空，说明需要新建棋盘/城池数据结构（或引入不同命名）。

### 2.2 search_for_pattern：现有端口/接口契约（避免重复造轮子）
- `Game.Core/Services/EventBus.cs`：`IEventBus`（`PublishAsync(DomainEvent)` / `Subscribe(...)`）
- `Game.Core/Ports/IDataStore.cs`：`IDataStore`（save/load/delete）
- `Game.Core/Ports/ILogger.cs`：`ILogger`（Info/Warn/Error）
- `Game.Core/Ports/ITime.cs`：`ITime`（DeltaSeconds 等）
- `Game.Core/Ports/IResourceLoader.cs`：`IResourceLoader`（LoadText/LoadBytes）

### 2.3 find_symbol：事件契约（ADR-0004 口径）
- `Game.Core/Contracts/DomainEvent.cs`：当前事件承载结构（`Type/Source/Timestamp/Id/Data/SpecVersion/DataContentType`）。
- `Game.Core/Contracts/CoreGameEvents.cs`：旧/兼容路径事件常量（如 `PlayerMoved`, `ScoreChanged`, `GameSaveCreated` 等）。
- `Game.Core/Contracts/Sanguo/BoardEvents.cs`：
  - `SanguoTokenMoved.EventType = core.sanguo.board.token.moved`（字段包含 `FromIndex/ToIndex/Steps/PassedStart`，与环形路线高度贴合）
  - `SanguoDiceRolled.EventType = core.sanguo.dice.rolled`
- 其他 T2 相关事件也已存在（供后续任务用）：`Game.Core/Contracts/Sanguo/EconomyEvents.cs`, `Game.Core/Contracts/Sanguo/GameEvents.cs`, `Game.Core/Contracts/Sanguo/PlayerAndAiEvents.cs`。

### 2.4 find_referencing_symbols：依赖引用/调用方式
- `GameEngineCore/Move` 的引用点主要在单元测试：`Game.Core.Tests/Engine/GameEngineCoreEventTests.cs`（3 处）。
- `Position` 的引用点：`GameState`、`Player`、`CollisionService.Distance(Position,Position)` 以及多个单元测试。
- `SanguoTokenMoved` 至少被 `Game.Core.Tests/Domain/SanguoContractsTests.cs` 引用（验证 EventType 常量）。
- `SanguoDiceRolled` 当前未发现引用点（Serena 引用查询为空）；建议在 Task 2 的 contracts 测试中补一条 EventType 断言，避免契约漂移。

## 3. 实现建议（止损视角）
- Task 2 的语义是‘环形棋盘 index’，而当前引擎移动语义是 ‘Position(dx,dy)’。建议：
  - 在 `Game.Core` 新增 `Board`/`Route`/`City` 的 index 模型（例如 `BoardIndex`/`BoardRoute`），用它驱动 `FromIndex/ToIndex`；
  - UI/场景层再把 index 映射为 `Position(X,Y)`（避免 Core 里混入 Godot/TileMap 坐标）。
- 事件层面优先对齐 `core.sanguo.board.token.moved` / `core.sanguo.dice.rolled`，避免继续扩展 `player.moved` 这类旧命名（与 ADR-0004 的迁移口径一致）。
