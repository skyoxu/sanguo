# Task 6 - 实现回合管理器

## 元信息
- 生成时间: 2025-12-17 21:47:01
- 映射字段: `tasks.json.master.tasks[].id` ↔ `tasks_back[].taskmaster_id` ↔ `tasks_gameplay[].taskmaster_id`
- Task ID: `6`
- Status: `in-progress`
- ADR Refs: ADR-0005, ADR-0015, ADR-0018, ADR-0020, ADR-0021, ADR-0024, ADR-0025
- CH Refs: CH01, CH04, CH05, CH06, CH07, CH09
- Overlay: `docs/architecture/overlays/PRD-SANGUO-T2/08/08-功能纵切-T2-三国大富翁闭环.md`

## tasks_back 关键验收点（taskmaster_id=6）
- 核心玩法相关类与方法在 Game.Core 中实现且不依赖 Godot API。
- 对应任务的 xUnit 测试用例存在并通过（见 test_refs 占位路径）。
- 符合学习模块二（回合 + 时间轴）的设计：回合推进与日期/月份/年度节点清晰可追踪，并与 T2 PRD 中的“日 → 月末 → 季度 → 年度”闭环描述一致。
- 回合/循环需正确处理出局：真人玩家出局立即 GameOver；NPC 出局退出本局并从后续轮转中移除（状态锁定），其已占领城池变为无人占领。
- Local demo references: C:\buildgame\godotdemo\dafuweng\Prototype ; C:\buildgame\godotdemo\dafuweng\casus-belli ; C:\buildgame\godotdemo\demo\godot-demo-projects\2d\pong
- 可选加固-审计追踪：记录出局事件与城池释放/转移；写入结构化审计日志 `logs/ci/<YYYY-MM-DD>/security-audit.jsonl`（字段至少 {ts, action, reason, target, caller}）。
- 可选加固-事件溯源：对关键状态变更发布 `DomainEvent`（ADR-0004），并保留 CorrelationId/CausationId 以支持回放与排障。
- 可选加固-资源限制：定义‘最大拥有城池数’上限（可配置），超限购买失败且记录审计/事件，避免状态膨胀与滥用。

## tasks_back 测试策略（taskmaster_id=6）
- 为核心玩法编写 xUnit + FluentAssertions 单元测试覆盖主要状态机与计算。
- 使用覆盖率工具（coverlet）确保核心逻辑达到 ADR-0005 规定的门禁。
- 参考 Godot 官方演示项目中基于 game loop 的示例（如 dodge_the_creeps、pong），编写 xUnit 测试模拟多轮回合推进，验证在不同起始日期与玩家顺序下，时间轴事件触发点与 PRD 定义完全对齐。
- 加入出局相关的轮转/结束用例：验证玩家出局触发 GameOver，NPC 出局后轮转跳过且不会再获得回合，并校验其城池已释放为无人占领。
- Local demo paths for implementation/tests: C:\buildgame\godotdemo\dafuweng\Prototype ; C:\buildgame\godotdemo\dafuweng\casus-belli ; C:\buildgame\godotdemo\demo\godot-demo-projects\2d\pong
- 加入 xUnit 用例：触发出局/城池释放/资金转移时，断言审计条目写入（可用内存 sink 或临时文件）且字段完整。
- 加入 xUnit 用例：关键状态变更均发布 DomainEvent；校验事件 type/source/id/correlationId 以及顺序可回放。
- 加入 xUnit 用例：当玩家拥有城池数达到上限时，购买被拒绝且状态不变，并写入审计条目。

## tasks_gameplay 关键验收点（taskmaster_id=6）
- 核心玩法相关类与方法在 Game.Core 中实现且不依赖 Godot API。
- 对应任务的 xUnit 测试用例存在并通过（见 test_refs 占位路径）。
- 符合学习模块二（回合 + 时间轴）的设计：回合推进与日期/月份/年度节点清晰可追踪，并与 T2 PRD 中的“日 → 月末 → 季度 → 年度”闭环描述一致。
- 回合/循环需正确处理出局：真人玩家出局立即 GameOver；NPC 出局退出本局并从后续轮转中移除（状态锁定），其已占领城池变为无人占领。
- Local demo references: C:\buildgame\godotdemo\dafuweng\Prototype ; C:\buildgame\godotdemo\dafuweng\casus-belli ; C:\buildgame\godotdemo\demo\godot-demo-projects\2d\pong
- 可选加固-审计追踪：记录出局事件与城池释放/转移；写入结构化审计日志 `logs/ci/<YYYY-MM-DD>/security-audit.jsonl`（字段至少 {ts, action, reason, target, caller}）。
- 可选加固-事件溯源：对关键状态变更发布 `DomainEvent`（ADR-0004），并保留 CorrelationId/CausationId 以支持回放与排障。
- 可选加固-资源限制：定义‘最大拥有城池数’上限（可配置），超限购买失败且记录审计/事件，避免状态膨胀与滥用。

## tasks_gameplay 测试策略（taskmaster_id=6）
- 为核心玩法编写 xUnit + FluentAssertions 单元测试覆盖主要状态机与计算。
- 使用覆盖率工具（coverlet）确保核心逻辑达到 ADR-0005 规定的门禁。
- 参考 Godot 官方演示项目中基于 game loop 的示例（如 dodge_the_creeps、pong），编写 xUnit 测试模拟多轮回合推进，验证在不同起始日期与玩家顺序下，时间轴事件触发点与 PRD 定义完全对齐。
- 加入出局相关的轮转/结束用例：验证玩家出局触发 GameOver，NPC 出局后轮转跳过且不会再获得回合，并校验其城池已释放为无人占领。
- Local demo paths for implementation/tests: C:\buildgame\godotdemo\dafuweng\Prototype ; C:\buildgame\godotdemo\dafuweng\casus-belli ; C:\buildgame\godotdemo\demo\godot-demo-projects\2d\pong
- 加入 xUnit 用例：触发出局/城池释放/资金转移时，断言审计条目写入（可用内存 sink 或临时文件）且字段完整。
- 加入 xUnit 用例：关键状态变更均发布 DomainEvent；校验事件 type/source/id/correlationId 以及顺序可回放。
- 加入 xUnit 用例：当玩家拥有城池数达到上限时，购买被拒绝且状态不变，并写入审计条目。

## Serena MCP 上下文（为实现 Task 6 准备）

### 1) find_symbol：相关核心符号
- `Game.Core/Engine/GameEngineCore.cs`：`GameEngineCore`（Start/Move/ApplyDamage/AddScore/End/Publish；依赖 `IEventBus`、`ITime`）
- `Game.Core/State/GameStateMachine.cs`：`GameStateMachine` + `GameFlowState`（Start/Pause/Resume/End/Transition；事件 `OnTransition`）
- `Game.Core/Services/SanguoDiceService.cs`：`SanguoDiceService.RollD6(gameId, playerId, correlationId, causationId)`（已在 Task 5 落地）
- `Game.Core/Services/EventBus.cs`：`IEventBus`（PublishAsync/Subscribe）
- `Game.Core/Contracts/DomainEvent.cs`：`DomainEvent`（CloudEvents 结构：Type/Source/Data/Timestamp/Id/SpecVersion/DataContentType）

### 2) search_for_pattern：接口定义（了解现有契约/端口）
- `Game.Core/Services/EventBus.cs`：`public interface IEventBus`
- `Game.Core/Ports/ITime.cs`：`public interface ITime`
- `Game.Core/Ports/IErrorReporter.cs`：`public interface IErrorReporter`（可观测性/审计相关）

### 3) find_symbol：事件契约（ADR-0004 对齐）
> 说明：以下事件均已存在于 Contracts 中；Task 6 实现应优先复用，不要新建契约文件。

```csharp
public const string SanguoGameTurnStarted = "core.sanguo.game.turn.started";
public const string SanguoGameTurnEnded   = "core.sanguo.game.turn.ended";
public const string SanguoGameTurnAdvanced= "core.sanguo.game.turn.advanced";
public const string SanguoDiceRolled      = "core.sanguo.dice.rolled";
```

- `Game.Core/Contracts/Sanguo/GameEvents.cs`：`SanguoGameTurnStarted` / `SanguoGameTurnEnded` / `SanguoGameTurnAdvanced`（含 CorrelationId/CausationId）
- `Game.Core/Contracts/Sanguo/BoardEvents.cs`：`SanguoDiceRolled`

### 4) find_referencing_symbols：依赖引用（现有模块如何使用）
- `GameStateMachine`：被 `Game.Core.Tests/State/GameStateMachineTests.cs` 使用（可直接复用其“状态推进”测试模式）
- `IEventBus`：被 `InMemoryEventBus`、`NullEventBus`、`CombatService`、`SanguoDiceService`、`GameEngineCore` 使用；Godot 层有 `Game.Godot/Adapters/EventBusAdapter.cs` 与 `Game.Godot/Autoloads/CompositionRoot.cs` 注入点
- `SanguoGameTurnStarted/Ended/Advanced`：被 `Game.Core.Tests/Domain/SanguoContractInstantiationTests.cs`（合约可实例化）与 `SanguoContractsTests.cs`（EventType 常量断言）引用
- `SanguoDiceRolled`：被 `SanguoDiceService` 与 `SanguoDiceServiceTests` 引用，说明事件发布方式已确定（DomainEvent + JsonElementEventData）
- `GameEngineCore`：被 `Game.Godot/Scripts/Demo/GameEngineDemo.cs` 与 `Game.Core.Tests/Engine/*` 使用（可参考其注入与事件发布习惯）

