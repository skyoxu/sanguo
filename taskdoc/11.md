# Task 11 ????Serena MCP ?????

- ?????2025-12-24 13:16:30
- Task ID?11

## ??????SSoT = tasks.json + tasks_back + tasks_gameplay?
- tasks.json: title=实现AI行为, status=in-progress, priority=medium
- dependencies: 4, 10
- adrRefs: ADR-0005, ADR-0015, ADR-0018, ADR-0020, ADR-0021, ADR-0024, ADR-0025
- archRefs: CH01, CH04, CH05, CH06, CH07, CH09
- overlay: docs/architecture/overlays/PRD-SANGUO-T2/08/08-功能纵切-T2-三国大富翁闭环.md
- details(??): 在 Game.Core 中实现 AI 按照与玩家相同的规则行动，初期使用简单贪心策略（有钱就买地、踩到别人地就付费），并预留将来扩展为有限状态机或行为树的接口。在状态组织与决策流程上，可参考 Godot 官方演示项目 2d/finite_state_machine 中对状态机的拆分方式，但在本项目中使用 C# 自定义实现。
- testStrategy(??): 编写 xUnit 用例，模拟多轮 AI 行动，在不同资金与地块分布下验证 AI 是否始终遵守游戏规则（不会越权修改他人状态），并检查在极端情况下（资金不足、无可购买地块）AI 仍然可以稳定执行回合而不抛出异常。
Local demo paths: C:\buildgame\godotdemo\demo\godot-demo-projects\2d\finite_state_machine ; C:\buildgame\godotdemo\dafuweng\Prototype
- tasks_back: status=pending, overlay_refs=docs/architecture/overlays/PRD-SANGUO-T2/08/_index.md, docs/architecture/overlays/PRD-SANGUO-T2/08/08-功能纵切-T2-三国大富翁闭环.md, docs/architecture/overlays/PRD-SANGUO-T2/08/ACCEPTANCE_CHECKLIST.md, test_refs=
- tasks_gameplay: status=pending, overlay_refs=docs/architecture/overlays/PRD-SANGUO-T2/08/08-功能纵切-T2-三国大富翁闭环.md, docs/architecture/overlays/PRD-SANGUO-T2/08/ACCEPTANCE_CHECKLIST.md, test_refs=
## ?? Serena ????????????/???????
- SanguoTurnManager
- AdvanceTurnAsync
- StartNewGameAsync
- SanguoEconomyManager
- TryBuyCityAndPublishEventAsync
- TryPayTollAndPublishEventAsync
- SettleMonth
- SanguoDiceService
- RollD6
- SanguoBoardState
- TryBuyCity
- TryGetOwnerOfCity
- SanguoPlayer
- TryBuyCity
- TryPayTollTo
- ISanguoPlayerView
- IEventBus
- DomainEvent
- SanguoAiDecisionMade
- SanguoPlayerStateChanged
- SanguoGameTurnStarted
- SanguoGameTurnAdvanced
- SanguoGameTurnEnded
- SanguoDiceRolled
- SanguoMonthSettled
- SanguoSeasonEventApplied
- SanguoYearPriceAdjusted
## ??????? AI ?????/??????
- Game.Core/Services/SanguoTurnManager.cs
- Game.Core/Services/SanguoEconomyManager.cs
- Game.Core/Services/SanguoDiceService.cs
- Game.Core/Domain/SanguoBoardState.cs
- Game.Core/Domain/SanguoPlayer.cs
- Game.Core/Domain/ISanguoPlayerView.cs
- Game.Core/Contracts/DomainEvent.cs
- Game.Core/Services/EventBus.cs
- Game.Core/Contracts/Sanguo/EconomyEvents.cs
- Game.Core/Contracts/Sanguo/GameEvents.cs
- Game.Core/Contracts/Sanguo/PlayerAndAiEvents.cs
## ??????? AI ?????/???
- Game.Core.Tests/Services/SanguoTurnManagerTests.cs
- Game.Core.Tests/Services/SanguoEconomyManagerTests.cs
- Game.Core.Tests/Services/SanguoDiceServiceTests.cs
- Game.Core.Tests/Domain/SanguoContractInstantiationTests.cs
## Symbol ???? Task 11 ?????
### ???? / ????
- SanguoTurnManager: StartNewGameAsync, AdvanceTurnAsync??? turn started/advanced/ended???/??/???????????

### ???????AI ???????
- SanguoEconomyManager: TryBuyCityAndPublishEventAsync, TryPayTollAndPublishEventAsync?????/???????
- SanguoEconomyManager: SettleMonth + PublishMonthSettlementIfBoundaryAsync?? TurnManager ???

### ??/???/????
- SanguoBoardState: TryBuyCity, TryGetOwnerOfCity, TryGetPlayer???/??????? BoardState ?????
- SanguoPlayer: TryBuyCity, TryPayTollTo, IsEliminated, OwnedCityIds, ToView?AI ??????? View/???????????
- ISanguoPlayerView: ?????????Money/PositionIndex/OwnedCityIds/IsEliminated?
## ??/???? Serena search_for_pattern ????????
- Game.Core/Services/EventBus.cs: IEventBus (PublishAsync, Subscribe)
- Game.Core/Domain/ISanguoPlayerView.cs: ISanguoPlayerView (PlayerId, Money, PositionIndex, OwnedCityIds, IsEliminated)
- Game.Core/Contracts/IEventData.cs: IEventData
- Game.Core/Ports/*.cs: ILogger, ITime, IInput, IDataStore, ISqlDatabase, IResourceLoader, IErrorReporter, IAudioPlayer ...
## ??????? ADR-0004?? Serena find_symbol ??????
- Game.Core/Contracts/Sanguo/GameEvents.cs: SanguoGameTurnStarted/Advanced/Ended
- Game.Core/Contracts/Sanguo/EconomyEvents.cs: SanguoMonthSettled, SanguoSeasonEventApplied, SanguoYearPriceAdjusted, SanguoCityBought, SanguoCityTollPaid
- Game.Core/Contracts/Sanguo/PlayerAndAiEvents.cs: SanguoAiDecisionMade, SanguoPlayerStateChanged
## ???/?????find_referencing_symbols ???
- SanguoTurnManager publishes turn events (Source=nameof(SanguoTurnManager)) and triggers economy month settlement on boundary.
- SanguoEconomyManager exposes TryBuyCityAndPublishEventAsync / TryPayTollAndPublishEventAsync; existing tests cover success/failure/rollback paths.
- SanguoDiceService publishes SanguoDiceRolled; unit tests validate publish + argument guards.
- ISanguoPlayerView is used by SanguoEconomyManager.CalculateMonthSettlements/CalculateMonthlyIncome for rule evaluation without mutating players.
- SanguoAiDecisionMade has at least one instantiation test (SanguoContractInstantiationTests).
## ?????????????????????
- AI ?? Core ????????? BoardState/PlayerView ???????? EconomyManager/TurnManager ?????????/?????
- ?? AI ??????/??????????? `ISanguoPlayerView` ??????????????????BoardState + EconomyManager??
- ?????????????? `SanguoAiDecisionMade`???????????????? `IEventBus.PublishAsync(DomainEvent)` ???
---
## sc-analyze?Task 11 ???????
- ?????2025-12-24 13:20:09
- ?????`logs/ci/2025-12-24/sc-analyze`
- ???`logs/ci/2025-12-24/sc-analyze/summary.json`
- ???`logs/ci/2025-12-24/sc-analyze/report.md`
- Task Context?`logs/ci/2025-12-24/sc-analyze/task_context.md`

### ????
- status?`ok`
- checks?`9` ??? ok

### Pattern Findings????/?????????????????
- `godot_os_execute`: 0
- `non_https_url`: 11
- `absolute_windows_path`: 10
- `thread_sleep`: 6
- `gc_collect`: 0

### ????? Task 11?
- Task 11 ?? Core AI ??????? sc-analyze ??????????????? TDD ?????
- Pattern Findings ??????/?????? http://???????????????????????????????? Task 11 ?????????????
