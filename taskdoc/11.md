# Task 11: 实现AI行为 - 上下文准备（实现用）

- 生成时间（本地）：2025-12-24 16:56:09 +0800
- 生成方式：Serena MCP（`find_symbol` / `search_for_pattern` / `find_referencing_symbols`）+ Python（UTF-8）落盘

## 1) 合并视图（三份任务文件的 SSoT）

- 映射字段：`tasks.json.master.tasks[].id` ↔ `tasks_back[].taskmaster_id` ↔ `tasks_gameplay[].taskmaster_id`
- Test-Refs 口径：以 `tasks_back.json:test_refs` 与 `tasks_gameplay.json:test_refs` 的并集为准（tasks.json 不含该字段）。

### tasks.json（Master）
- id: `11`
- title: 实现AI行为
- status: `in-progress`
- priority: `medium`
- dependencies: 4, 10
- adrRefs: ADR-0005, ADR-0015, ADR-0018, ADR-0020, ADR-0021, ADR-0024, ADR-0025
- archRefs: CH01, CH04, CH05, CH06, CH07, CH09
- overlay: `docs/architecture/overlays/PRD-SANGUO-T2/08/08-功能纵切-T2-三国大富翁闭环.md`

**子任务（仅存在于 tasks.json）**
- 1: 实现AI基本规则逻辑 (status=pending)
- 2: 预留状态机接口 (status=pending)
- 3: 编写AI行为测试用例 (status=pending)

### tasks_back.json（Backlog/验收补充）
- status: `pending`
- overlay_refs:
- `docs/architecture/overlays/PRD-SANGUO-T2/08/_index.md`
- `docs/architecture/overlays/PRD-SANGUO-T2/08/08-功能纵切-T2-三国大富翁闭环.md`
- `docs/architecture/overlays/PRD-SANGUO-T2/08/ACCEPTANCE_CHECKLIST.md`
- test_refs:
- (empty)
- acceptance（关注约束口径）:
- 核心玩法相关类与方法在 Game.Core 中实现且不依赖 Godot API。
- 对应任务的 xUnit 测试用例存在并通过（见 test_refs 占位路径）。
- Local demo references: C:\buildgame\godotdemo\demo\godot-demo-projects\2d\finite_state_machine ; C:\buildgame\godotdemo\dafuweng\Prototype
- AI 决策读取玩家状态必须通过 `ISanguoPlayerView`（推荐使用 `SanguoPlayer.ToView()` 生成 `SanguoPlayerView` 快照），禁止直接持有/跨线程访问 `SanguoPlayer` 实体；后台线程仅接收快照输入。参考：`Game.Core/Domain/ISanguoPlayerView.cs`、`Game.Core/Domain/SanguoPlayer.cs:ToView()`、`Game.Core/Domain/SanguoPlayerView.cs`。

### tasks_gameplay.json（Gameplay/验收补充）
- status: `pending`
- overlay_refs:
- `docs/architecture/overlays/PRD-SANGUO-T2/08/08-功能纵切-T2-三国大富翁闭环.md`
- `docs/architecture/overlays/PRD-SANGUO-T2/08/ACCEPTANCE_CHECKLIST.md`
- test_refs:
- (empty)

**一致性风险（必须显式管理）**
- `tasks.json` 的 Task 11 为 `in-progress`，但 `tasks_back.json/tasks_gameplay.json` 对应条目仍为 `pending`。
- `tasks_back.json/tasks_gameplay.json` 的 `test_refs` 为空；如果后续门禁以这两份为准，会出现“实现/测试已存在但验收缺引用”的结构性失败。

## 2) Serena find_symbol：关键实现落点（用于避免重复定义）

### Core services
- `Game.Core/Services/SanguoTurnManager.cs`: `StartNewGameAsync`, `AdvanceTurnAsync`, `PublishAiDecisionIfNeededAsync`, `IsAiPlayerId`
- `Game.Core/Services/SanguoEconomyManager.cs`: `TryBuyCityAndPublishEventAsync`, `TryPayTollAndPublishEventAsync`, `SettleMonth`, `CalculateMonthSettlements`, `PublishMonthSettlementIfBoundaryAsync`, `PublishSeasonEventIfBoundaryAsync`, `PublishYearlyPriceAdjustmentIfBoundaryAsync`
- `Game.Core/Services/SanguoDiceService.cs`: `RollD6`
- `Game.Core/Services/EventBus.cs`: `IEventBus`, `InMemoryEventBus`

### Core domain
- `Game.Core/Domain/SanguoBoardState.cs`: `TryBuyCity`, `TryGetOwnerOfCity`, `TryGetPlayer`
- `Game.Core/Domain/ISanguoPlayerView.cs`: `ISanguoPlayerView`
- `Game.Core/Domain/SanguoPlayer.cs`: `SanguoPlayer`, `ToView`
- `Game.Core/Domain/SanguoPlayerView.cs`: `SanguoPlayerView`

### Contracts (ADR-0004 naming)
- `Game.Core/Contracts/DomainEvent.cs`: `DomainEvent`
- `Game.Core/Contracts/Sanguo/PlayerAndAiEvents.cs`: `SanguoAiDecisionMade`, `SanguoPlayerStateChanged`
- `Game.Core/Contracts/Sanguo/GameEvents.cs`: `SanguoGameTurnStarted`, `SanguoGameTurnEnded`, `SanguoGameTurnAdvanced`
- `Game.Core/Contracts/Sanguo/BoardEvents.cs`: `SanguoBoardTokenMoved`, `SanguoDiceRolled`
- `Game.Core/Contracts/Sanguo/EconomyEvents.cs`: `SanguoMonthSettled`, `SanguoSeasonEventApplied`, `SanguoYearPriceAdjusted`, `SanguoCityBought`, `SanguoCityTollPaid`

### Task 11 tests
- `Game.Core.Tests/Tasks/Task11AiBehaviorTests.cs`: `ShouldPublishAiDecisionMade_WhenTurnStartsForAi`


## 3) Serena search_for_pattern：契约/事件命名（ADR-0004 口径）

- EventType 常量（扫描结果摘要）：
- `core.sanguo.ai.decision.made`
- `core.sanguo.player.state.changed`
- `core.sanguo.game.turn.started`
- `core.sanguo.game.turn.ended`
- `core.sanguo.game.turn.advanced`
- `core.sanguo.dice.rolled`
- `core.sanguo.board.token.moved`
- `core.sanguo.economy.month.settled`
- `core.sanguo.economy.season.event.applied`
- `core.sanguo.economy.year.price.adjusted`
- `core.sanguo.city.bought`
- `core.sanguo.city.toll.paid`

## 4) Serena find_referencing_symbols：已存在依赖使用方式（摘要）

### `SanguoAiDecisionMade`
- 生产端：`Game.Core/Services/SanguoTurnManager.cs`
- 测试端：`Game.Core.Tests/Tasks/Task11AiBehaviorTests.cs`
- 合同实例化用例：`Game.Core.Tests/Domain/SanguoContractInstantiationTests.cs`

### `ISanguoPlayerView`
- 经济计算：`Game.Core/Services/SanguoEconomyManager.cs` 使用 `ISanguoPlayerView` 做快照计算
- 快照投影：`Game.Core/Domain/SanguoPlayer.cs` 提供 `ToView()`

### `IEventBus`
- Core：`Game.Core/Services/EventBus.cs`
- Godot 适配：`Game.Godot/Adapters/EventBusAdapter.cs`
