# Task 16：实现年度地价调整

- 生成时间：2026-01-02
- 目的：为 Task 16 的 TDD / 实现提供“任务三联 SSoT + 代码入口 + 事件契约 + 关键依赖”的可读上下文（UTF-8）。

## 1. 任务三联（SSoT）摘要

- `tasks.json`（master）
  - id：16
  - title：实现年度地价调整
  - status：pending
  - details：在每年年初，随机调整城池的基础价格和过路费。
  - adrRefs：ADR-0005、ADR-0015、ADR-0018、ADR-0020、ADR-0021、ADR-0024、ADR-0025
  - archRefs：CH01、CH04、CH05、CH06、CH07、CH09
  - overlay：`docs/architecture/overlays/PRD-SANGUO-T2/08/08-feature-slice-t2-monopoly-loop.md`

- `tasks_back.json` / `tasks_gameplay.json`（视图）
  - taskmaster_id：16
  - contractRefs：`core.sanguo.economy.year.price.adjusted`
  - acceptance（Refs 由 `test_refs` 汇总，测试中需包含 `ACC:T16.<n>` anchors）：
    - ACC:T16.1：年度调价规则/计算可在纯 C# 单测中验证（不依赖 Godot）。
    - ACC:T16.2：跨年边界必须执行一次调价（基础价 + 过路费），并写入可观测城池状态。
    - ACC:T16.3：随机性：不同随机输入允许不同；相同可控随机输入必须一致。
    - ACC:T16.4：作用域限制：只允许修改城池经济字段（基础价/过路费），不得修改所有权/位置/出局/回合推进等。

## 2. 关键代码入口（实现与验证的骨干）

- 回合推进（跨年触发入口）：`Game.Core/Services/SanguoTurnManager.cs`（`AdvanceTurnAsync`）
- 年度调价计算/应用：`Game.Core/Services/SanguoEconomyManager.cs`（`ApplyYearlyPriceAdjustment`）
- 年度调价事件发布：`Game.Core/Services/SanguoEconomyManager.cs`（`PublishYearlyPriceAdjustmentIfBoundaryAsync`）
- 将调价写入可观测城池状态：`Game.Core/Domain/SanguoBoardState.cs`（`ApplyCityEconomyUpdates`）

## 3. 事件契约（ADR-0004 口径）

- 事件类型：`core.sanguo.economy.year.price.adjusted`
- 契约位置：`Game.Core/Contracts/Sanguo/EconomyEvents.cs`（`SanguoYearPriceAdjusted`）

## 4. 测试文件（Refs / anchors 绑定目标）

- `Game.Core.Tests/Tasks/Task16YearEndPriceTests.cs`
  - 预期覆盖：ACC:T16.1~T16.4（xUnit；纯 C#；可复现 RNG；含跨年边界行为验证）
