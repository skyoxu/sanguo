# ADR-0027: 所有权唯一写入口（Ownership Write Entry）

- Status: Accepted
- Context: “城池/地块所有权”属于跨玩法核心状态，会被经济规则、事件系统、AI 与 UI 同时读取。如果没有唯一写入口，容易出现多处写入导致的状态漂移（例如绕过唯一性校验、出局释放不一致、或 UI/AI 直接篡改 OwnedIds）。
- Decision:
  - 唯一写入口：所有权的写入（购买、转移、出局释放等）只允许通过 Core 服务层的受控入口执行（例如 Economy/Ownership 管理器）；UI/AI/Adapters 不得直接修改玩家的 OwnedIds 或城池的 Owner 字段。
  - 统一判定：所有权的“判定”（某城池当前属于谁）必须由单一的领域上下文/聚合统一裁决（需要同时看到玩家集合与城池集合），并对“多重所有者/状态冲突”视为状态损坏（fail-fast）。
  - 只读投影接口：上层读取路径（UI/AI）应通过只读投影接口暴露必要字段（例如 `ISanguoPlayerView`），避免把可变集合直接暴露给上层。
  - 回归用例锁定：必须用 xUnit 把关键不变式钉死（例如：出局后城池释放、出局玩家不可再交易、所有权唯一性始终成立）。
- Consequences:
  - 正向：降低状态漂移；提升验收一致性；更容易把“所有权相关规则”纳入 acceptance_check 的确定性硬门禁。
  - 代价：需要服务层承担更多编排；部分测试需要通过受控入口覆盖内部状态变更路径。
- References:
  - ADR-0021: C# 领域层架构
  - ADR-0004: 事件总线与契约（购买/支付产生事件）
  - ADR-0005: 质量门禁（覆盖率与回归用例）
